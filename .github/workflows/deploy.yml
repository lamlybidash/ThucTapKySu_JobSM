name: Deploy Laravel App

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull latest code
        run: |
          git pull origin master

      - name: Setup
        run: |
          composer install --no-dev --optimize-autoloader

      - name: Deploy Docker
        run: |
          docker-compose down --remove-orphans
          docker-compose up -d --scale app=3 --build

      - name: Run migrations and seed database
        run: |
          docker-compose exec -T app php artisan migrate --force
          docker-compose exec -T app php artisan db:seed --force

      - name: Create storage link
        run: docker-compose exec -T app php artisan storage:link          